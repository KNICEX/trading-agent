# TradingService 集成测试说明

## 测试概览

本测试套件包含 5 个集成测试，覆盖 `TradingService` 的核心功能。

| 测试名称 | 是否实际交易 | 测试内容 | 预计成本 |
|---------|------------|---------|---------|
| TestOpenPositionWithBalance | ❌ | 余额百分比开仓（限价单） | 0 USDT |
| TestOpenPositionWithQuantity | ❌ | 指定数量开仓（限价单） | 0 USDT |
| TestOpenPositionWithStopOrders | ✅ | 市价开仓 + 止盈止损 | ~110 USDT |
| TestClosePosition | ✅ | 分批平仓功能 | ~110 USDT |
| 总计 | - | - | ~220 USDT |

## 测试详情

### 1. TestOpenPositionWithBalance
**测试目标：** 使用余额百分比开仓

**测试流程：**
1. 清理环境（取消所有订单和仓位）
2. 查看账户余额
3. 使用 5% 余额开多仓（限价 50000 USDT，不会成交）
4. 验证订单已创建
5. 清理订单和仓位

**关键验证点：**
- ✓ 余额百分比计算正确
- ✓ 数量精度处理正确
- ✓ 订单成功创建
- ✓ 预估成本和价格准确

**预期输出：**
```
=== 账户信息 ===
可用余额: 1312.51919937 USDT

=== 限价开仓（使用 5% 余额）===
开仓成功:
  订单ID: 803641357480
  预估成本: 65.6259599685 USDT
  预估价格: 50000 USDT
当前挂单数量: 34
```

---

### 2. TestOpenPositionWithQuantity
**测试目标：** 指定具体数量开仓

**测试流程：**
1. 清理环境
2. 限价开空仓 0.001 BTC（价格 150000 USDT，不会成交）
3. 验证订单状态和数量
4. 清理订单和仓位

**关键验证点：**
- ✓ 指定数量开仓正确
- ✓ 空仓限价单价格设置正确（高于市价）
- ✓ 订单数量精度处理正确
- ✓ 订单状态为 NEW

**预期输出：**
```
=== 限价开空仓（指定数量）===
开仓成功:
  订单ID: 803642006867
  预估成本: 7.5 USDT
订单状态: NEW
订单数量: 0.001
```

---

### 3. TestOpenPositionWithStopOrders ⚠️
**测试目标：** 市价开仓并设置止盈止损

**⚠️ 注意：此测试会实际开仓并产生费用**

**测试流程：**
1. 清理环境（取消订单 + 平仓）
2. 市价开多仓 0.001 BTC（约 110 USDT，20倍杠杆）
3. 同时设置止盈单（150000 USDT）和止损单（90000 USDT）
4. 验证仓位已创建
5. 验证止盈止损单已挂上
6. 清理：取消止盈止损单 + 市价平仓

**关键验证点：**
- ✓ 市价单立即成交
- ✓ 仓位已创建且数量正确
- ✓ 止盈单和止损单成功创建
- ✓ 返回所有订单 ID
- ✓ 平仓成功清理

**预期输出：**
```
=== 市价开多仓（带止盈止损，约100U）===
开仓成功:
  主订单ID: 803642345678
  止盈单ID: 803642345679
  止损单ID: 803642345680
  预估成本: 5.5 USDT
  预估价格: 109145.50 USDT

=== 验证仓位 ===
多仓信息:
  数量: 0.001 BTC
  开仓均价: 109150.20 USDT
  当前盈亏: -0.05 USDT
  保证金: 5.46 USDT
  杠杆: 20x

=== 验证止盈止损单 ===
当前挂单数量: 2
找到止盈单: 价格 150000, 数量 0.001
找到止损单: 价格 90000, 数量 0.001

=== 清理仓位和订单 ===
止盈单已取消
止损单已取消
平仓成功，订单ID: 803642345681

=== 最终验证 ===
✓ 所有仓位已平掉
```

**成本分析：**
- 开仓成本：0.001 BTC × 109000 USDT ÷ 20倍杠杆 = ~5.5 USDT 保证金
- 手续费（Maker 0.02%）：0.001 × 109000 × 0.02% ≈ 0.022 USDT
- 平仓手续费（Taker 0.04%）：0.001 × 109000 × 0.04% ≈ 0.044 USDT
- **总成本：约 0.066 USDT**

---

### 4. TestClosePosition ⚠️
**测试目标：** 测试分批平仓功能

**⚠️ 注意：此测试会实际开仓并产生费用**

**测试流程：**
1. 清理环境
2. 市价开多仓 0.001 BTC
3. 验证仓位并记录初始数量
4. 平掉 50% 仓位（使用 Percent）
5. 验证剩余仓位约为初始的 50%
6. 全部平仓（使用 CloseAll）
7. 验证所有仓位已清理

**关键验证点：**
- ✓ 按百分比平仓计算正确
- ✓ 剩余仓位数量符合预期
- ✓ 全部平仓功能正常
- ✓ 精度处理正确

**预期输出：**
```
=== 步骤1: 开多仓 ===
开仓成功，订单ID: 803642890123
预估成本: 5.5 USDT
初始仓位: 0.001 BTC

=== 步骤2: 平掉 50% 多仓 ===
平仓订单ID: 803642890124
剩余仓位: 0.0005 BTC (预期约 0.0005 BTC)
当前盈亏: -0.02 USDT

=== 步骤3: 全部平仓 ===
平仓订单ID: 803642890125

=== 最终验证 ===
✓ 所有多仓已平掉
```

**成本分析：**
- 开仓手续费：0.001 × 109000 × 0.04% ≈ 0.044 USDT
- 第一次平仓（50%）：0.0005 × 109000 × 0.04% ≈ 0.022 USDT
- 第二次平仓（剩余）：0.0005 × 109000 × 0.04% ≈ 0.022 USDT
- **总成本：约 0.088 USDT**

---

## 运行测试

### 运行全部测试
```bash
cd /home/aster/workspace/trading-agent
go test -v ./internal/service/exchange/binance/integration/ -run "TestOpenPosition|TestClosePosition"
```

### 运行单个测试
```bash
# 仅测试余额百分比开仓（不产生费用）
go test -v ./internal/service/exchange/binance/integration/ -run TestOpenPositionWithBalance

# 仅测试止盈止损（会产生费用）
go test -v ./internal/service/exchange/binance/integration/ -run TestOpenPositionWithStopOrders

# 仅测试分批平仓（会产生费用）
go test -v ./internal/service/exchange/binance/integration/ -run TestClosePosition
```

### 跳过实际交易测试
```bash
# 仅运行限价单测试（不会实际成交）
go test -v ./internal/service/exchange/binance/integration/ -run "TestOpenPositionWith(Balance|Quantity)"
```

## 预期总成本

| 测试 | 开仓数量 | 手续费率 | 预估费用 |
|-----|---------|---------|---------|
| TestOpenPositionWithStopOrders | 0.001 BTC | 开仓 0.04% + 平仓 0.04% | ~0.066 USDT |
| TestClosePosition | 0.001 BTC | 开仓 0.04% + 2次平仓 0.08% | ~0.088 USDT |
| **总计** | - | - | **~0.154 USDT** |

**注意：** 
- 实际费用可能因市场价格波动而有所不同
- 如果仓位有盈亏，最终成本会相应增减
- 使用 BNB 支付手续费可享受 10% 折扣

## 安全注意事项

### 1. 测试环境配置
确保在配置文件中使用测试账户的 API 密钥：

```yaml
# config/config.dev.yaml
exchange:
  binance:
    api_key: "your_test_api_key"
    api_secret: "your_test_api_secret"
```

### 2. 资金控制
- 测试账户建议只放少量资金（100-200 USDT）
- 测试前确认账户余额充足
- 定期检查测试账户交易记录

### 3. 清理机制
所有测试都包含完整的清理逻辑：
- 测试开始前：清理所有订单和仓位
- 测试结束后：取消订单 + 平掉所有仓位
- 即使测试失败，也会尽量执行清理

### 4. 限价单保护
限价单测试使用极端价格，确保不会意外成交：
- 开多仓限价：50000 USDT（远低于市价）
- 开空仓限价：150000 USDT（远高于市价）

## 故障排除

### 问题1: 精度错误
```
code=-1111, msg=Precision is over the maximum defined for this asset.
```

**解决方案：** 
已在 `TradingService` 中自动处理精度问题。如遇到新的交易对，在 `trading.go` 的 `roundQuantity` 函数中添加配置。

### 问题2: 余额不足
```
code=-2019, msg=Margin is insufficient.
```

**解决方案：**
1. 确保测试账户有足够余额（建议 >100 USDT）
2. 降低杠杆倍数或减少开仓数量
3. 检查是否有未平仓位占用保证金

### 问题3: 限价单价格错误
```
code=-4024, msg=Limit price can't be lower than 109145.00
```

**解决方案：**
- 开多仓（买入）：限价必须 ≥ 市价
- 开空仓（卖出）：限价必须 ≤ 市价
- 已在测试中使用极端价格避免此问题

### 问题4: 仓位未完全平掉
```
警告：仍有多仓未完全平掉（可能是精度问题）
```

**说明：**
这通常不是错误，可能原因：
1. 币安合约的最小数量限制
2. 精度截断导致微小余量
3. 剩余数量小于最小交易单位

## 最佳实践

1. **测试前准备**
   - 清空测试账户的所有订单和仓位
   - 确保有足够余额（建议 200 USDT）
   - 检查网络连接稳定性

2. **测试顺序**
   - 先运行限价单测试（不产生费用）
   - 确认无误后再运行市价单测试
   - 逐个运行，避免并发问题

3. **监控和记录**
   - 关注测试输出日志
   - 记录每次测试的费用
   - 定期检查测试账户余额变化

4. **问题排查**
   - 保存失败测试的完整日志
   - 检查币安账户的订单历史
   - 确认没有遗留的挂单或仓位

