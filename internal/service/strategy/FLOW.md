# ç­–ç•¥å¼•æ“ä¸»å¾ªç¯æµç¨‹å›¾

## å®Œæ•´æµç¨‹

```
ç¨‹åºå¯åŠ¨
   â†“
main()
   â†“
åˆ›å»º exchange æœåŠ¡
   â”œâ”€ MarketService
   â”œâ”€ TradingService  
   â”œâ”€ PositionService
   â””â”€ OrderService
   â†“
åˆ›å»º Context (å®ç›˜/å›æµ‹)
   â†“
åˆ›å»º Strategy å®ä¾‹
   â†“
åˆ›å»º Executor
   â†“
åˆ›å»º Engine
   â†“
engine.Start(ctx) â† å¯åŠ¨ä¸»å¾ªç¯
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Engine ä¸»å¾ªç¯ï¼ˆgoroutineï¼‰                â”‚
â”‚                                          â”‚
â”‚ 1. strategy.Initialize()                â”‚
â”‚    â†“                                     â”‚
â”‚ 2. å¯åŠ¨å®šæ—¶å™¨                             â”‚
â”‚    ticker = NewTicker(pollInterval)      â”‚
â”‚    â†“                                     â”‚
â”‚ 3. å¾ªç¯ç›‘å¬                               â”‚
â”‚    for {                                 â”‚
â”‚      select {                            â”‚
â”‚        case <-ticker.C:                  â”‚ â† æ¯éš” N åˆ†é’Ÿè§¦å‘ä¸€æ¬¡
â”‚          â†“                                â”‚
â”‚          fetchAndProcessKline() â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
â”‚                                          â”‚
â”‚        case <-stopChan:                  â”‚
â”‚          â†“                                â”‚
â”‚          strategy.Shutdown()            â”‚
â”‚          return                          â”‚
â”‚      }                                   â”‚
â”‚    }                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

fetchAndProcessKline() è¯¦ç»†æµç¨‹ï¼š
   â†“
è·å–æœ€æ–°1æ ¹Kçº¿
   â†“
â”Œâ”€ æ˜¯å¦å·²å¤„ç†è¿‡ï¼Ÿâ”€ YES â†’ è·³è¿‡ï¼Œç­‰å¾…ä¸‹æ¬¡
â”‚     â†“ NO
â””â”€â†’ Kçº¿æ˜¯å¦å®Œæˆï¼Ÿâ”€ NO â†’ è·³è¿‡ï¼Œç­‰å¾…å®Œæˆ
      â†“ YES
   æ ‡è®°ä¸ºå·²å¤„ç†
      â†“
   æ‰“å°æ—¥å¿—ï¼šæ–°Kçº¿
      â†“
   æ„é€  Bar å¯¹è±¡
      â†“
   è°ƒç”¨ strategy.OnBar(bar) â”€â”€â”€â”
      â†“                         â”‚â† è¿™æ˜¯è°ƒç”¨ç­–ç•¥çš„æ—¶åˆ»ï¼
   è¿”å› Signalï¼Ÿ                â”‚
      â†“                         â”‚
   â”Œâ”€ signal == nilï¼Ÿâ”€ YES â†’ æ—¥å¿—ï¼šæ— ä¿¡å·ï¼Œè¿”å›
   â”‚    â†“ NO
   â””â”€â†’ signal.IsValid()ï¼Ÿâ”€ NO â†’ æ—¥å¿—ï¼šæ— æ•ˆä¿¡å·ï¼Œè¿”å›
        â†“ YES
   æ‰“å°æ—¥å¿—ï¼šç­–ç•¥ä¿¡å·
        â†“
   executor.Execute(signal)
        â†“
   æ ¹æ®ä¿¡å·ç±»å‹æ‰§è¡Œï¼š
        â”œâ”€ LONG   â†’ tradingSvc.OpenPosition(å¤š)
        â”œâ”€ SHORT  â†’ tradingSvc.OpenPosition(ç©º)
        â”œâ”€ ADD    â†’ tradingSvc.OpenPosition(åŠ ä»“)
        â”œâ”€ REDUCE â†’ tradingSvc.ClosePosition(å‡ä»“)
        â”œâ”€ CLOSE  â†’ tradingSvc.ClosePosition(å¹³ä»“)
        â””â”€ HOLD   â†’ ä¸æ“ä½œ
        â†“
   è¿”å›ï¼Œç­‰å¾…ä¸‹æ¬¡Kçº¿
```

## æ—¶é—´çº¿ç¤ºä¾‹ï¼ˆ1å°æ—¶Kçº¿ï¼‰

```
æ—¶é—´è½´ï¼š
10:00 â”€â”€â”€â”€â”€â”€â”€â”€ 10:30 â”€â”€â”€â”€â”€â”€â”€â”€ 11:00 â”€â”€â”€â”€â”€â”€â”€â”€ 11:30 â”€â”€â”€â”€â”€â”€â”€â”€ 12:00
  â”‚              â”‚              â”‚              â”‚              â”‚
  Kçº¿1å¼€å§‹       è½®è¯¢1          Kçº¿1ç»“æŸ       è½®è¯¢2          Kçº¿2ç»“æŸ
                 (æ— æ–°Kçº¿)      â†“              (æ— æ–°Kçº¿)      â†“
                                å¤„ç†Kçº¿1                       å¤„ç†Kçº¿2
                                â†“                              â†“
                                è°ƒç”¨ OnBar()                   è°ƒç”¨ OnBar()
                                â†“                              â†“
                                è¿”å›ä¿¡å·                       è¿”å›ä¿¡å·
                                â†“                              â†“
                                æ‰§è¡Œäº¤æ˜“                       æ‰§è¡Œäº¤æ˜“
```

## ç­–ç•¥å†…éƒ¨æµç¨‹ï¼ˆOnBarï¼‰

```
strategy.OnBar(bar) è¢«è°ƒç”¨
   â†“
1. è·å–å†å²Kçº¿
   ctx.GetKlines(limit: 50)
   â†“
2. è®¡ç®—æŠ€æœ¯æŒ‡æ ‡
   ma20 = calculateMA(klines, 20)
   ma50 = calculateMA(klines, 50)
   rsi = calculateRSI(klines, 14)
   â†“
3. è·å–å½“å‰æŒä»“
   position = ctx.GetPositions(pair)
   â†“
4. åˆ¤æ–­æŒä»“çŠ¶æ€
   â”œâ”€ æ— æŒä»“ â†’ åˆ¤æ–­å¼€ä»“ä¿¡å·
   â”‚   â”œâ”€ é‡‘å‰ â†’ return Signal(LONG)
   â”‚   â”œâ”€ æ­»å‰ â†’ return Signal(SHORT)
   â”‚   â””â”€ å…¶ä»– â†’ return Signal(HOLD)
   â”‚
   â””â”€ æœ‰æŒä»“ â†’ åˆ¤æ–­æ“ä½œä¿¡å·
       â”œâ”€ è¶‹åŠ¿åè½¬ â†’ return Signal(CLOSE)
       â”œâ”€ ç›ˆåˆ©>5% â†’ return Signal(ADD)
       â”œâ”€ äºæŸ>3% â†’ return Signal(REDUCE)
       â””â”€ å…¶ä»– â†’ return Signal(HOLD)
```

## å¤šä¸ªå…³é”®æ—¶åˆ»

### 1. å¯åŠ¨æ—¶åˆ»
```
main() â†’ engine.Start() â†’ strategy.Initialize()
```

### 2. æ¯æ¬¡è½®è¯¢ï¼ˆæ¯Nåˆ†é’Ÿï¼‰
```
ticker.C è§¦å‘ â†’ fetchAndProcessKline()
```

### 3. Kçº¿å®Œæˆæ—¶ï¼ˆè°ƒç”¨ç­–ç•¥ï¼‰
```
Kçº¿CloseTimeå·²è¿‡ â†’ strategy.OnBar() â†’ è¿”å›Signal
```

### 4. ä¿¡å·æ‰§è¡Œæ—¶
```
Signalè¿”å› â†’ executor.Execute() â†’ tradingSvc.OpenPosition/ClosePosition
```

### 5. åœæ­¢æ—¶åˆ»
```
æ”¶åˆ°SIGINT â†’ engine.Stop() â†’ strategy.Shutdown() â†’ é€€å‡º
```

## å¹¶å‘æ¨¡å‹

```
main goroutine
   â†“
   â”œâ”€ engine1.Start() â†’ å¯åŠ¨ goroutine 1
   â”‚   â””â”€ runKlineLoop() â† ç‹¬ç«‹è¿è¡Œ
   â”‚       â””â”€ æ¯30åˆ†é’Ÿè½®è¯¢
   â”‚
   â”œâ”€ engine2.Start() â†’ å¯åŠ¨ goroutine 2
   â”‚   â””â”€ runKlineLoop() â† ç‹¬ç«‹è¿è¡Œ
   â”‚       â””â”€ æ¯30åˆ†é’Ÿè½®è¯¢
   â”‚
   â””â”€ ç­‰å¾…ä¿¡å·
       <-sigChan
       â†“
       engine1.Stop()
       engine2.Stop()
```

## å®é™…è¿è¡Œæ—¥å¿—ç¤ºä¾‹

```
2024-01-15 10:00:00 [Engine] ç­–ç•¥å¼•æ“å¯åŠ¨: MA_Strategy, äº¤æ˜“å¯¹: BTCUSDT, å‘¨æœŸ: 1h
2024-01-15 10:00:00 [MA_Strategy] ç­–ç•¥åˆå§‹åŒ–: å¿«çº¿=20, æ…¢çº¿=50
2024-01-15 10:00:00 [Engine] ç­–ç•¥åˆå§‹åŒ–å®Œæˆ: MA_Strategy
2024-01-15 10:00:00 [Engine] Kçº¿è½®è¯¢å¯åŠ¨ï¼Œé—´éš”: 30m0s

2024-01-15 10:30:00 â† ç¬¬1æ¬¡è½®è¯¢ï¼ˆKçº¿æœªå®Œæˆï¼Œè·³è¿‡ï¼‰
2024-01-15 11:00:00 â† ç¬¬2æ¬¡è½®è¯¢ï¼ˆKçº¿å®Œæˆï¼‰
2024-01-15 11:00:01 [Engine] æ–°Kçº¿: BTCUSDT 2024-01-15 10:00:00, Open: 45000, Close: 45200
2024-01-15 11:00:01 [MA_Strategy] æ”¶åˆ°Kçº¿: 2024-01-15 10:00:00
2024-01-15 11:00:02 [MA_Strategy] MA(20)=44800.00, MA(50)=44500.00
2024-01-15 11:00:02 [MA_Strategy] é‡‘å‰ä¿¡å·ï¼Œå‡†å¤‡åšå¤š
2024-01-15 11:00:02 [Engine] ç­–ç•¥ä¿¡å·: LONG, Size: 30.00%, Reason: MAé‡‘å‰ä¿¡å·
2024-01-15 11:00:02 [Executor] æ‰§è¡Œä¿¡å·: LONG, Size: 30.00%, Reason: MAé‡‘å‰ä¿¡å·
2024-01-15 11:00:03 [Executor] å¼€å¤šä»“æˆåŠŸ: OrderID=123456, é¢„ä¼°æˆæœ¬=1000.00

2024-01-15 11:30:00 â† ç¬¬3æ¬¡è½®è¯¢ï¼ˆæ— æ–°Kçº¿ï¼Œè·³è¿‡ï¼‰
2024-01-15 12:00:00 â† ç¬¬4æ¬¡è½®è¯¢ï¼ˆæ–°Kçº¿å®Œæˆï¼‰
2024-01-15 12:00:01 [Engine] æ–°Kçº¿: BTCUSDT 2024-01-15 11:00:00, Open: 45200, Close: 45500
2024-01-15 12:00:01 [MA_Strategy] æ”¶åˆ°Kçº¿: 2024-01-15 11:00:00
2024-01-15 12:00:02 [MA_Strategy] MA(20)=44950.00, MA(50)=44600.00
2024-01-15 12:00:02 [MA_Strategy] å½“å‰æŒä»“: LONG, ç›ˆäº: 6.50%
2024-01-15 12:00:02 [MA_Strategy] ç›ˆåˆ©6.50%ï¼ŒåŠ ä»“
2024-01-15 12:00:02 [Engine] ç­–ç•¥ä¿¡å·: ADD, Size: 10.00%, Reason: è¶‹åŠ¿å¼ºåŠ²ï¼ŒåŠ ä»“
2024-01-15 12:00:02 [Executor] æ‰§è¡Œä¿¡å·: ADD, Size: 10.00%, Reason: è¶‹åŠ¿å¼ºåŠ²ï¼ŒåŠ ä»“
2024-01-15 12:00:03 [Executor] åŠ ä»“æˆåŠŸ: OrderID=123457

... ç»§ç»­å¾ªç¯ ...

^C â† ç”¨æˆ·æŒ‰ Ctrl+C
2024-01-15 15:30:00 [Engine] æ”¶åˆ°é€€å‡ºä¿¡å·ï¼ˆcontextï¼‰
2024-01-15 15:30:00 [Engine] æ­£åœ¨å…³é—­ç­–ç•¥: MA_Strategy
2024-01-15 15:30:00 [MA_Strategy] ç­–ç•¥å…³é—­
2024-01-15 15:30:00 [Engine] ç­–ç•¥å¼•æ“å·²åœæ­¢
```

## æ ¸å¿ƒè¦ç‚¹

1. **å®šæ—¶è½®è¯¢**ï¼šæ¯éš”ä¸€æ®µæ—¶é—´æ£€æŸ¥ä¸€æ¬¡
2. **Kçº¿å®Œæˆ**ï¼šåªå¤„ç†å·²å®Œæˆçš„Kçº¿
3. **é˜²é‡å¤**ï¼šæ¯æ ¹Kçº¿åªå¤„ç†ä¸€æ¬¡
4. **è°ƒç”¨æ—¶æœº**ï¼šKçº¿å®Œæˆåç«‹å³è°ƒç”¨ `OnBar()`
5. **å¼‚æ­¥æ‰§è¡Œ**ï¼šä¸»å¾ªç¯åœ¨ç‹¬ç«‹çš„ goroutine ä¸­è¿è¡Œ
6. **ä¼˜é›…é€€å‡º**ï¼šç›‘å¬ä¿¡å·ï¼Œæ¸…ç†èµ„æº

å°±è¿™ä¹ˆç®€å•ï¼ğŸ¯

